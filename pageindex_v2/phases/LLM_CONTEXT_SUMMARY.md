# Tree Auditor V2 - 提交给LLM的上下文总结

## 📋 概述

Tree Auditor V2系统通过**5轮渐进式审核**优化文档目录结构。每轮向LLM提交不同的上下文和任务。

---

## 🎯 各阶段上下文详情

### Phase 1: 文档分类 (Document Classification)

**目标**: 识别文档类型（招标/投标/合同/学术等10种类型）

**提交的上下文**:
```python
{
    "titles": [  # 前15个标题
        "1. Preface / 前言",
        "2. 第二章 投标人须知",
        "3. （一）适用范围",
        ...
    ],
    "rule_result": {  # 规则初步判断结果（参考）
        "type": "tender",
        "confidence": 0.44
    },
    "document_types": [  # 10种支持的类型（仅名称）
        "1. tender (招标文件)",
        "2. bid (投标文件)",
        ...
    ]
}
```

**关键点**:
- ✅ **不提供类型规则**，让LLM基于自身知识判断
- ✅ 只提供前15个标题样本（token节省）
- ✅ 规则判断仅作参考，LLM可以override

**LLM任务**: 分析标题特征，返回文档类型 + 置信度 + 判断理由

---

### Round 1: DELETE (删除无效节点)

**目标**: 删除误识别的非标题内容

**提交的上下文**:
```python
{
    "document_type": "tender",  # 已识别的文档类型
    "title_pattern": "第X章 > 一、 > （一） > 1、",  # 该类型的标准编号层级
    "flat_nodes": [  # 前50个扁平化节点（真实数据）
        {
            "id": "0000",
            "title": "Preface / 前言",
            "level": 1,
            "page_start": 1,
            "page_end": 5
        },
        {
            "id": "0005",
            "title": "5、投标文件格式中的表格式样可以根据...",
            "level": 3,
            "page_start": 11,
            "page_end": 11
        },
        # ... 48个节点
    ],
    "delete_rules": [  # 删除情况（无示例数据）
        "1. 完整句子 - 长度过长且包含完整语义的正文句子",
        "2. 正文条款 - 以编号开头的详细条款内容",
        "3. 页眉页脚 - 重复出现的页码、文件名",
        "4. 重复标题 - 完全相同的标题重复",
        "5. 明显不是标题 - 日期、签名、表格标签",
        "6. 检查子节点 - 有子节点的通常是真实标题"
    ]
}
```

**关键点**:
- ✅ **无示例数据**，避免LLM模仿
- ✅ 提供真实的50个节点（包含id/title/level/pages）
- ✅ 强调"保守原则"和"检查上下文"

**LLM任务**: 返回需要删除的节点列表（action=DELETE）

---

### Round 2: MODIFY_FORMAT (格式标准化)

**目标**: 修正标题格式（标点、编号）

**提交的上下文**:
```python
{
    "document_type": "tender",
    "title_pattern": "第X章 > 一、 > （一） > 1、",
    "flat_nodes": [同Round 1的50个节点],
    "format_rules": [  # 格式修正规则（无示例）
        "1. 标点符号 - 标题不应以句号、逗号等标点结尾",
        "2. 编号格式不规范 - 同一层级的编号应统一格式",
        "3. 编号跳跃修正 - （一）→（三）→（五）应前移为（一）→（二）→（三）",
        "4. 特殊标题保护 - 附件/前言/温馨提示等不强制添加'第X章'"
    ],
    "constraints": [  # 关键约束
        "严格限制: 只能调整编号格式和标点符号，绝对不能改变标题的文字内容",
        "内容保持: 标题的实质性文字必须完全保持不变",
        "特殊标题: 识别并保护特殊类型标题的原有编号风格"
    ]
}
```

**关键点**:
- ✅ **无示例数据**（如"第一章。" → "第一章"）
- ✅ 明确**特殊标题白名单**（附件/前言/温馨提示等）
- ✅ **强约束**: 不能改变内容，只能改格式
- ✅ 支持自动修正编号跳跃

**LLM任务**: 返回格式修正建议（action=MODIFY_FORMAT）

---

### Round 3: CHECK_SEQUENCE (编号连续性检查)

**目标**: 检测缺失的编号（如（一）→（三），缺失（二））

**提交的上下文**:
```python
{
    "document_type": "tender",
    "numbering_rules": "章用'第X章'，一级用'一、二、三、'，二级用'（一）（二）（三）'，三级用'1、2、3、'",
    "hierarchical_tree": """  # 层级可视化树（最关键！）
第二章 投标人须知 [p.6-14]
  （一）适用范围 [p.10-10]
  （二）定义 [p.10-10]
  （三）投标费用 [p.10-14]
    6、本项目不允许分包 [p.11-14]
3、中标人的投标文件... [p.15-55]
  一、评标 [p.16-55]
    （一）评审工作的组织 [p.16-16]
    （二）评标委员会的组建 [p.16-16]
    （三）评标委员会的职责 [p.16-17]
    （五）评审意见的争议处理 [p.17-17]  ← 从（三）跳到（五）！
    （六）评委纪律 [p.17-17]
    （七）评审流程及内容 [p.17-17]
    """,
    "check_rules": [  # 检查规则（无示例）
        "1. 章节编号连续性 - 检查'第X章'是否连续",
        "2. 一级标题连续性 - 检查'一、二、三、'是否连续",
        "3. 二级标题连续性 - 检查'（一）（二）（三）'是否连续",
        "4. 数字编号连续性 - 检查'1、2、3、'是否连续"
    ]
}
```

**关键点**:
- ✅ **层级可视化树**是最重要的上下文（带缩进和页码）
- ✅ **无示例结构**（如"第一章→第三章 ← 缺失'第二章'"）
- ✅ LLM可以直观看到编号跳跃（如（三）→（五））
- ✅ 要求LLM推测缺失节点的页码范围

**LLM任务**: 返回缺失的编号序列（missing_sequences）

---

### Round 4: ADD (添加缺失节点)

**目标**: 基于Round 3的检测结果生成ADD建议

**上下文**: ❌ **不调用LLM**

**处理逻辑**:
```python
# 直接基于Round 3的结果转换
for seq in missing_sequences:
    advice.append({
        "action": "ADD",
        "suggested_title": seq["expected_pattern"],  # 例如 "（四）XXX"
        "suggested_level": seq["level"],
        "insert_position": seq["position"],
        "confidence": "medium",
        "needs_pdf_verification": True,
        "note": "标题内容需要从PDF中读取"
    })
```

**关键点**:
- ✅ 确定性转换，无需LLM
- ⚠️ 标题内容为"XXX"占位符（当前无法自动提取）

---

### Round 5: MODIFY_PAGE (页码修正)

**目标**: 检测页码异常（跨度过大/过小/重叠）

**上下文**: ❌ **不调用LLM**

**处理逻辑**:
```python
# 确定性规则检测
for node in flat_nodes:
    span = node.page_end - node.page_start + 1
    
    # 规则1: 页码跨度过大
    if span > 20 and node.level <= 2:
        advice.append({
            "action": "MODIFY_PAGE",
            "node_id": node.id,
            "reason": f"页码跨度过大({span}页)",
            "confidence": "low"
        })
    
    # 规则2: 与下一个节点重叠
    if node.page_end >= next_node.page_start:
        advice.append({...})
```

**关键点**:
- ✅ 完全确定性，无需LLM
- ⚠️ 需要PDF核实才能执行

---

## 📊 上下文总览表

| 阶段 | 调用LLM? | 主要输入 | 输入大小 | 是否有示例 |
|------|---------|---------|---------|-----------|
| **Phase 1: 分类** | ✅ | 前15个标题<br>10种类型名 | ~500 tokens | ❌ 无示例 |
| **Round 1: DELETE** | ✅ | 前50个节点<br>6条删除规则 | ~3000 tokens | ❌ 无示例 |
| **Round 2: FORMAT** | ✅ | 前50个节点<br>4条格式规则<br>3条约束 | ~3000 tokens | ❌ 无示例 |
| **Round 3: SEQUENCE** | ✅ | 可视化树<br>4条检查规则 | ~2000 tokens | ❌ 无示例 |
| **Round 4: ADD** | ❌ | Round 3结果 | - | - |
| **Round 5: PAGE** | ❌ | 页码信息 | - | - |

---

## 🎯 优化亮点

### 1. **不提供规则，信任LLM**
- Phase 1文档分类不提供关键词/模式规则
- 让LLM基于自身知识判断

### 2. **无示例数据，避免模仿**
- 所有prompt移除示例输出
- 只提供真实的文档节点数据

### 3. **层级可视化树** (Round 3最重要！)
```
第二章 投标人须知 [p.6-14]
  （一）适用范围 [p.10-10]
  （二）定义 [p.10-10]
  （三）投标费用 [p.10-14]
  （五）评审意见的争议处理 [p.17-17]  ← 缺失（四）！
```
- 带缩进和页码，直观展示结构
- LLM可以轻松发现编号跳跃

### 4. **强约束保护内容** (Round 2)
```
严格限制: 只能调整编号格式和标点符号，绝对不能改变标题的文字内容
```
- 防止"前言" → "第一章 前言"
- 防止"附件1" → "第六章 附件1"

### 5. **特殊标题白名单** (Round 2)
```
4. 特殊标题保护 - 以下不强制添加'第X章':
   - 附件类: "附件"、"附录"
   - 前置类: "前言"、"Preface"
   - 后置类: "温馨提示"、"说明"
```

### 6. **确定性 + LLM混合**
- Round 3/4/5优先用确定性算法
- Round 1/2需要语义理解，使用LLM

---

## 💡 关键设计原则

1. **分轮次专注**: 每轮只做一件事，避免混淆
2. **真实数据优先**: 只提供真实节点，不提供虚构示例
3. **信任LLM能力**: 不过度限制规则，让LLM自主判断
4. **强约束保护**: 明确"不能改内容"，只能改格式
5. **可视化上下文**: Round 3的树形展示是最直观的输入

---

## 📝 待改进

1. **Round 1误报**: 长标题被误判为完整句子
   - 建议: 增加"是否在TOC中"检查
   
2. **Round 4无法补全**: 只能检测缺失，不能提取标题
   - 建议: 在缺失页码范围内搜索标题模式
   
3. **Round 5未生效**: 页码格式兼容性问题
   - 建议: 支持多种页码字段名

---

**总结**: 优化后的系统不依赖预定义规则，不提供示例数据，让LLM基于真实的文档结构和自身知识做出判断，应该能提升准确性和泛化能力。
