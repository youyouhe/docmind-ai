# Tree Auditor V2 - Prompt优化记录

## 优化日期
2024年（当前会话）

## 优化原则

### 1. **移除预定义规则，让LLM自主判断**
**原因**: LLM本身具备强大的领域知识和判断能力，过多的规则限制反而会降低其表现。

**优化前**:
```
支持的文档类型：
1. tender (招标文件) - 政府/企业采购招标
2. bid (投标文件) - 供应商响应招标
3. contract (合同文件) - 协议、合同
...
```

**优化后**:
```
支持的文档类型：
1. tender (招标文件)
2. bid (投标文件)
3. contract (合同文件)
...
基于你的知识和对标题的理解判断文档类型，不要依赖我提供的特征规则
```

### 2. **移除示例数据，避免模仿输出**
**原因**: 示例数据可能被LLM误当作真实数据复制，导致输出不准确。

**优化前**:
```
# 需要删除的情况
1. **完整句子** - 长度>60字符，包含完整语义
   例如："4、投标人不得相互串通投标报价，不得妨碍..."
   
2. **正文条款** - 以数字编号开头但很长（>50字符）
   例如："1、本项目的投标人必须具备..."
```

**优化后**:
```
# 需要删除的情况
1. **完整句子** - 长度过长且包含完整语义的正文句子
2. **正文条款** - 以编号开头的详细条款内容（非标题）
```

### 3. **移除JSON代码块标记，简化格式**
**原因**: 去掉```json```标记，减少格式干扰。

**优化前**:
```
# 返回格式
```json
{{
  "advice": [...]
}}
```

**优化后**:
```
# 返回格式
{{
  "advice": [...]
}}
```

### 4. **增强约束说明，防止误改内容**
**原因**: 强调只能调整格式，不能改变内容，保护用户的搜索功能。

**新增约束** (Round 2):
```
# 关键约束
- **严格限制**: 只能调整编号格式和标点符号，**绝对不能改变标题的文字内容**
- **内容保持**: 标题的实质性文字必须完全保持不变
- **特殊标题**: 识别并保护特殊类型标题的原有编号风格
```

### 5. **添加特殊标题白名单**
**原因**: 防止LLM给所有标题强制添加"第X章"编号。

**新增规则** (Round 2):
```
4. **特殊标题保护** - 以下类型的标题不要强制添加章节编号：
   - 附件类: "附件"、"附录"开头的标题
   - 前置类: "前言"、"Preface"、"序言"等
   - 后置类: "温馨提示"、"说明"、"参考资料"等
```

### 6. **增强上下文检查提示**
**原因**: 提醒LLM考虑节点的层级关系，避免误删真实标题。

**新增提示** (Round 1):
```
6. **检查子节点** - 如果一个节点有子节点，通常说明它是真实的章节标题，不应删除
```

---

## 各阶段优化详情

### Phase 1: Document Classification

**优化内容**:
- ✅ 移除文档类型的详细描述（如"政府/企业采购招标"）
- ✅ 添加"基于你的知识判断，不要依赖提供的规则"
- ✅ 移除`max_retries`参数（方法不支持）

**优化后的核心Prompt**:
```python
支持的文档类型：
1. tender (招标文件)
2. bid (投标文件)
...
10. general (通用文档)

要求：
1. 如果规则判断的置信度 >= 0.8，优先采纳
2. 仔细分析标题的编号方式、用词特征、结构层次
3. 置信度要客观反映判断的确定性
4. 基于你的知识和对标题的理解判断文档类型，不要依赖我提供的特征规则
```

---

### Round 1: DELETE

**优化内容**:
- ✅ 移除所有示例数据（如"4、投标人不得相互串通..."）
- ✅ 移除JSON代码块标记
- ✅ 简化删除规则描述
- ✅ 添加"检查子节点"提示
- ✅ 将"规范"改为"标准编号层级"（更准确）

**优化后的核心Prompt**:
```python
# 需要删除的情况
1. **完整句子** - 长度过长且包含完整语义的正文句子
2. **正文条款** - 以编号开头的详细条款内容（非标题）
3. **页眉页脚** - 重复出现的页码、文件名等元信息
4. **重复标题** - 完全相同的标题重复出现多次
5. **明显不是标题** - 日期、签名、表格标签等非标题内容
6. **检查子节点** - 如果一个节点有子节点，通常说明它是真实的章节标题，不应删除

# 原则
- **保守原则**: 只删除明显错误的节点（confidence >= medium）
- **宁可漏删**: 不确定的保留，后续轮次再处理
- **不要管格式**: 这一轮不关心格式问题，只删除明显的误识别
- **检查上下文**: 考虑节点的层级关系和子节点情况
```

---

### Round 2: MODIFY_FORMAT

**优化内容**:
- ✅ 移除所有格式修正示例（如"第一章 招标公告。" → "第一章 招标公告"）
- ✅ 移除JSON代码块标记
- ✅ 移除`examples`字段
- ✅ 添加"特殊标题保护"白名单
- ✅ 添加"编号跳跃修正"规则（自动前移编号）
- ✅ 强化"不能改变内容"的约束说明

**优化后的核心Prompt**:
```python
# 需要修正的格式问题
1. **标点符号** - 标题不应以句号、逗号等标点结尾
2. **编号格式不规范** - 同一层级的编号应统一格式
3. **编号跳跃修正** - 如果编号不连续（如（一）→（三）→（五）），将后续编号前移以保持连续性
4. **特殊标题保护** - 以下类型的标题不要强制添加章节编号：
   - 附件类: "附件"、"附录"开头的标题
   - 前置类: "前言"、"Preface"、"序言"等
   - 后置类: "温馨提示"、"说明"、"参考资料"等

# 关键约束
- **严格限制**: 只能调整编号格式和标点符号，**绝对不能改变标题的文字内容**
- **内容保持**: 标题的实质性文字必须完全保持不变
- **特殊标题**: 识别并保护特殊类型标题的原有编号风格
```

---

### Round 3: CHECK_SEQUENCE

**优化内容**:
- ✅ 移除所有示例结构（如"第一章→第三章 ← 缺失'第二章'"）
- ✅ 移除JSON代码块标记
- ✅ 简化检查规则描述
- ✅ 保留层级可视化树（这是最重要的上下文，不能删除）

**优化后的核心Prompt**:
```python
# 检查规则
1. **章节编号连续性** - 检查"第X章"是否连续
2. **一级标题连续性** - 检查"一、二、三、"或"1、2、3、"是否连续
3. **二级标题连续性** - 检查"（一）（二）（三）"是否连续
4. **数字编号连续性** - 检查"1、2、3、"或"1.1、1.2、1.3"是否连续

# 原则
1. **基于编号规律** - 只有编号明确缺失才报告
2. **高置信度** - 如果前后节点都存在且编号明确，confidence=high
3. **页码推测** - 根据前后节点的页码范围推测缺失节点的页码
4. **保守原则** - 不确定的不要报告
```

---

### Round 4 & Round 5

**无需优化**: 这两轮不调用LLM，使用确定性算法处理。

---

## 优化效果预期

### 1. **更准确的文档分类**
- LLM可以利用其完整的知识库判断文档类型
- 不受限于预定义的关键词和规则

### 2. **更少的误删除**
- 移除示例数据避免LLM过度模仿
- 添加"检查子节点"提示减少误判

### 3. **更智能的格式修正**
- 特殊标题白名单保护附件、前言等标题
- 强化约束防止内容被改变

### 4. **更准确的编号检查**
- 移除示例避免LLM被误导
- 保留可视化树（最重要的真实上下文）

---

## 待验证

### 需要在下次测试中验证:

1. ✅ 文档分类是否更准确（不依赖规则）
2. ✅ DELETE建议是否减少误报（不删除长标题）
3. ✅ MODIFY_FORMAT是否保护特殊标题（附件、前言等）
4. ✅ 整体执行率是否提升（更合理的建议）

---

## 回滚指南

如果优化后效果不佳，可以通过Git回滚到优化前的版本：

```bash
git log --oneline -- lib/docmind-ai/pageindex_v2/phases/
git checkout <commit-hash> -- lib/docmind-ai/pageindex_v2/phases/
```

或者手动恢复示例数据到prompt中。

---

## 总结

本次优化遵循两个核心原则：

1. **信任LLM的能力** - 让LLM基于其知识判断，而不是限制其规则
2. **保护真实数据** - 只提供真实的文档数据，不提供可能被模仿的示例

这些优化应该能提升Tree Auditor V2的准确性和实用性。
