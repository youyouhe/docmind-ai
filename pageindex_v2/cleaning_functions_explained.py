"""
清理函数实现原理图解
"""

print("""
╔═══════════════════════════════════════════════════════════════════════╗
║                      TOC 清理函数实现原理                              ║
╚═══════════════════════════════════════════════════════════════════════╝

┌─────────────────────────────────────────────────────────────────────┐
│ 函数 1: _clean_toc_format(text)                                     │
│ 作用：清理目录格式，将点号转为冒号                                    │
└─────────────────────────────────────────────────────────────────────┘

【正则表达式 1】
Pattern:  r'\\.{{4,}}'
含义:     \\. = 匹配点号 (需要转义)
         {{4,}} = 匹配 4 个或更多次

示例：
  输入:  "第一章 引言....................5"
  匹配:            ^^^^^^^^^^^^^^^^^^^^  (20个点号)
  替换为: ": "
  输出:  "第一章 引言: 5"

【正则表达式 2】
Pattern:  r'(?:\\. )\\.{{3,}}'
含义:     (?:\\. ) = 匹配 ". " (点号+空格，不捕获)
         \\.{{3,}} = 然后匹配 3 个或更多点号

示例：
  输入:  "第二章. . . . . 10"
  匹配:        ^^^^^^^^^^^  (. 空格 . . . .)
  替换为: ": "
  输出:  "第二章: 10"


┌─────────────────────────────────────────────────────────────────────┐
│ 函数 2: _remove_page_footers(text)                                  │
│ 作用：移除页脚的页码标记                                              │
└─────────────────────────────────────────────────────────────────────┘

【正则表达式 1 - 中文页脚】
Pattern:  r'第\\s*\\d+\\s*页\\s*共\\s*\\d+\\s*页'
含义:     第 + 空格(0-n) + 数字(1-n) + 空格(0-n) + 页
         + 空格(0-n) + 共 + 空格(0-n) + 数字(1-n) + 空格(0-n) + 页

元字符说明：
  \\s*  = 匹配 0 个或多个空白字符（空格、tab等）
  \\d+  = 匹配 1 个或多个数字 [0-9]

示例：
  输入:  "第 4 页 共 78 页"
  匹配:  ^^^^^^^^^^^^^^^  (整个字符串)
  替换为: "" (空字符串)
  输出:  ""

变体匹配：
  ✓ "第4页共78页"       (无空格)
  ✓ "第 5 页 共 100 页" (单空格)
  ✓ "第  10  页  共  50  页" (多空格)

【正则表达式 2 - 英文页脚】
Pattern:  r'Page\\s+\\d+\\s+of\\s+\\d+'
含义:     Page + 空格(1-n) + 数字(1-n) + 空格(1-n) + of + 空格(1-n) + 数字(1-n)

元字符说明：
  \\s+  = 匹配 1 个或多个空白字符（至少要有一个空格）

示例：
  输入:  "Page 10 of 50"
  匹配:  ^^^^^^^^^^^^^  (整个字符串)
  替换为: ""
  输出:  ""

注意：使用 flags=re.IGNORECASE，所以也匹配：
  ✓ "PAGE 10 OF 50"
  ✓ "page 10 of 50"
  ✓ "PaGe 10 Of 50"

【正则表达式 3 - 简单页码】
Pattern:  r'-\\s*\\d+\\s*-'
含义:     - + 空格(0-n) + 数字(1-n) + 空格(0-n) + -

示例：
  输入:  "- 5 -"
  匹配:  ^^^^^  (整个字符串)
  替换为: ""
  输出:  ""

变体匹配：
  ✓ "- 5 -"   (有空格)
  ✓ "-5-"     (无空格)
  ✓ "-  10  -" (多空格)


┌─────────────────────────────────────────────────────────────────────┐
│ 使用流程                                                             │
└─────────────────────────────────────────────────────────────────────┘

在 detect_page_numbers_in_toc() 方法中的调用顺序：

  1. 获取原始 TOC 内容
     ↓
  2. 调用 _clean_toc_format(toc_content)
     将 "....." 转为 ": "
     ↓
  3. 调用 _remove_page_footers(toc_content)
     移除 "第 X 页 共 Y 页" 等页脚
     ↓
  4. 将清理后的内容发送给 LLM 分析
     LLM 只看到真正的目录内容，不会被页脚误导


┌─────────────────────────────────────────────────────────────────────┐
│ 实际案例对比                                                          │
└─────────────────────────────────────────────────────────────────────┘

【案例：pages-78.pdf 的目录页】

原始内容：
┌─────────────────────────────────────┐
│ 目 录                                │
│ 第一部分 投标邀请函                   │
│ 第二部分 采购项目内容                 │
│ 第三部分 投标人须知                   │
│ 第四部分 合同格式                     │
│ 第五部分 投标文件格式                 │
│ 第 4 页 共 78 页                     │
└─────────────────────────────────────┘
        ↓ _clean_toc_format()
        (本例中没有点号，所以无变化)
        ↓
        ↓ _remove_page_footers()
        (移除 "第 4 页 共 78 页")
        ↓
清理后内容：
┌─────────────────────────────────────┐
│ 目 录                                │
│ 第一部分 投标邀请函                   │
│ 第二部分 采购项目内容                 │
│ 第三部分 投标人须知                   │
│ 第四部分 合同格式                     │
│ 第五部分 投标文件格式                 │
└─────────────────────────────────────┘

LLM 分析结果：
✓ 正确识别：没有页码（因为章节标题后面没有数字）
✗ 修复前错误：有页码（误将页脚当成页码）


┌─────────────────────────────────────────────────────────────────────┐
│ Python 正则表达式元字符速查表                                         │
└─────────────────────────────────────────────────────────────────────┘

  \\d    = 数字 [0-9]
  \\s    = 空白字符（空格、tab、换行等）
  \\w    = 单词字符 [a-zA-Z0-9_]
  
  +     = 1 次或多次（贪婪匹配）
  *     = 0 次或多次（贪婪匹配）
  ?     = 0 次或 1 次
  {{n,m}} = n 到 m 次
  {{n,}}  = n 次或更多
  
  .     = 任意字符（除换行）
  \\.    = 转义的点号（匹配真实的 . 字符）
  
  ^     = 字符串开头
  $     = 字符串结尾
  
  []    = 字符集 [abc] 匹配 a、b 或 c
  ()    = 分组
  (?:)  = 非捕获分组
  
  |     = 或运算符
  
  re.IGNORECASE = 忽略大小写的标志


┌─────────────────────────────────────────────────────────────────────┐
│ 总结                                                                 │
└─────────────────────────────────────────────────────────────────────┘

这两个清理函数通过正则表达式：

1. 统一格式：将各种形式的点号转为统一的冒号格式
2. 过滤噪音：移除页脚标记，避免 LLM 误判
3. 提高准确性：确保 LLM 只分析真正的目录页码

关键设计：
- 使用 \\s* 处理可选空格，增加容错性
- 使用 \\d+ 匹配任意长度数字
- 使用 re.IGNORECASE 支持大小写
- 先清理格式，再移除页脚，顺序很重要

""")
