# æ–‡æ¡£è§£æé—®é¢˜åˆ†ææŠ¥å‘Š
## æ–‡æ¡£ID: 53b33b4f-9c5e-43db-b91d-354d5aaa00b1

## é—®é¢˜æ¦‚è¿°
è§£æåçš„æ–‡æ¡£ç›®å½•ç»“æ„ä¸ç†æƒ³ï¼Œå­˜åœ¨ä»¥ä¸‹ä¸»è¦é—®é¢˜ï¼š
1. æ ‡é¢˜æå–é”™è¯¯ï¼ˆå†…å®¹è¢«å½“ä½œæ ‡é¢˜ï¼‰
2. å±‚çº§ç»“æ„æ··ä¹±
3. å•å­—ç¬¦æ ‡é¢˜ï¼ˆ"æŠ¥"ã€"ä»·"ã€"æ–‡"ã€"ä»¶"ï¼‰
4. å†…å®¹é‡å¤

## æ ¹æœ¬åŸå› 

é€šè¿‡åˆ†æPDFçš„åµŒå…¥å¼TOCï¼Œå‘ç°**é—®é¢˜æ ¹æºåœ¨äºPDFæ–‡ä»¶æœ¬èº«çš„ä¹¦ç­¾ç»“æ„å­˜åœ¨é”™è¯¯**ï¼š

### åµŒå…¥å¼TOCçš„é—®é¢˜

```
âœ“ æ­£ç¡®çš„ç« èŠ‚:
 1. [Level 1] ç¬¬ä¸€ç«  æ‹›æ ‡å…¬å‘Š
 2. [Level 1] ç¬¬äºŒç«  æŠ•æ ‡äººé¡»çŸ¥
20. [Level 1] ç¬¬ä¸‰ç«  è¯„æ ‡åŠæ³•åŠè¯„åˆ†æ ‡å‡†

âŒ é”™è¯¯çš„"ç« èŠ‚"ï¼ˆå®é™…æ˜¯å†…å®¹ç‰‡æ®µï¼‰:
 9. [Level 1] 3ã€ä¸­æ ‡äººçš„æŠ•æ ‡æ–‡ä»¶è‡ªå¼€æ ‡ä¹‹æ—¥èµ·è‡³åˆåŒå±¥è¡Œå®Œæ¯•å‡åº”ä¿æŒæœ‰æ•ˆã€‚
21. [Level 1] æ³¨ï¼š1ï¼‰ä¸Šè¿°è¯„åˆ†é¡¹ï¼Œç¼ºé¡¹ä¸å¾—åˆ†ã€‚
22. [Level 1]     2ï¼‰ä¸Šè¿°è¯æ˜ææ–™ä¸­çš„å•ä½åç§°ä¸æŠ•æ ‡å•ä½çš„åç§°å¿…é¡»ä¸€è‡´...
26-30. [Level 1] "æŠ¥", "ä»·", "æ–‡", "ä»¶", "ä¾›åº”å•†å…¨ç§°ï¼ˆå…¬ç« ï¼‰ï¼š"
```

###åˆ†æ

1. **Item #9** æ˜¯ä¸€æ®µæ™®é€šæ–‡å­—ï¼Œå´è¢«æ ‡è®°ä¸º Level 1ï¼ˆç« èŠ‚çº§åˆ«ï¼‰
2. **Items #21-22** æ˜¯æ³¨é‡Šè¯´æ˜ï¼Œä¸åº”è¯¥ä½œä¸ºç‹¬ç«‹ç« èŠ‚
3. **Items #26-30** æ˜¯å•ä¸ªæ±‰å­—ï¼Œæ˜æ˜¾æ˜¯PDFåˆ¶ä½œæ—¶çš„é”™è¯¯
4. **Items #3-8** çš„å±‚çº§å…³ç³»æ­£ç¡®ï¼Œä½† **Items #10-19** æœ¬åº”å±äº"ç¬¬äºŒç« "çš„å­é¡¹ï¼Œå´åµŒå¥—åœ¨äº† Item #9 ä¹‹ä¸‹

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: è¿‡æ»¤å’Œæ¸…ç†åµŒå…¥å¼TOCï¼ˆæ¨èï¼‰

åœ¨ TOC æå–é˜¶æ®µæ·»åŠ æ™ºèƒ½è¿‡æ»¤è§„åˆ™ï¼š

#### A. æ ‡é¢˜é•¿åº¦è¿‡æ»¤
```python
# è¿‡æ»¤è¿‡é•¿çš„"æ ‡é¢˜"ï¼ˆå¾ˆå¯èƒ½æ˜¯å†…å®¹ç‰‡æ®µï¼‰
MAX_TITLE_LENGTH = 30  # å­—ç¬¦æ•°

def is_valid_title(title: str) -> bool:
    # å»é™¤ç©ºç™½åæ£€æŸ¥é•¿åº¦
    clean_title = title.strip()
    
    # 1. è¿‡æ»¤è¿‡é•¿çš„æ ‡é¢˜ï¼ˆè¶…è¿‡30å­—ç¬¦å¾ˆå¯èƒ½æ˜¯å†…å®¹ï¼‰
    if len(clean_title) > MAX_TITLE_LENGTH:
        return False
    
    # 2. è¿‡æ»¤å•å­—ç¬¦æ ‡é¢˜
    if len(clean_title) <= 1:
        return False
    
    # 3. è¿‡æ»¤çœ‹èµ·æ¥åƒå®Œæ•´å¥å­çš„æ ‡é¢˜ï¼ˆåŒ…å«å¥å·ã€é€—å·ç­‰ï¼‰
    if any(punct in clean_title for punct in ['ã€‚', 'ï¼Œ', 'ã€', 'ï¼š', 'ï¼›']):
        # ä¾‹å¤–ï¼šåƒ"ï¼ˆä¸€ï¼‰é€‚ç”¨èŒƒå›´"è¿™æ ·çš„æ˜¯åˆæ³•çš„
        if not (clean_title.startswith('ï¼ˆ') or clean_title.startswith('ç¬¬')):
            return False
    
    return True
```

#### B. æ ‡é¢˜æ¨¡å¼è¯†åˆ«
```python
import re

def is_chapter_title(title: str) -> bool:
    """åˆ¤æ–­æ˜¯å¦æ˜¯ç« èŠ‚æ ‡é¢˜"""
    chapter_patterns = [
        r'^ç¬¬[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+ç« ',  # ç¬¬ä¸€ç« ã€ç¬¬äºŒç« 
        r'^\d+[ã€\.]',  # 1ã€ æˆ– 1.
        r'^[ï¼ˆ\(][ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹å]+[ï¼‰\)]',  # ï¼ˆä¸€ï¼‰ã€ï¼ˆäºŒï¼‰
        r'^é™„ä»¶\s*\d*[ï¼š:]?',  # é™„ä»¶1:ã€é™„ä»¶:
    ]
    
    for pattern in chapter_patterns:
        if re.match(pattern, title.strip()):
            return True
    
    return False

def clean_toc(toc_items):
    """æ¸…ç†TOCï¼Œè¿‡æ»¤æ— æ•ˆé¡¹"""
    cleaned = []
    
    for item in toc_items:
        title = item['title']
        
        # åŸºæœ¬éªŒè¯
        if not is_valid_title(title):
            logger.warning(f"è¿‡æ»¤æ— æ•ˆæ ‡é¢˜: {title}")
            continue
        
        # Level 1 é¡¹å¿…é¡»çœ‹èµ·æ¥åƒç« èŠ‚æ ‡é¢˜
        if item['level'] == 1 and not is_chapter_title(title):
            logger.warning(f"è¿‡æ»¤éç« èŠ‚æ ‡é¢˜: {title}")
            continue
        
        cleaned.append(item)
    
    return cleaned
```

#### C. å±‚çº§ä¿®å¤
```python
def fix_toc_hierarchy(toc_items):
    """ä¿®å¤å±‚çº§å…³ç³»æ··ä¹±çš„TOC"""
    fixed = []
    last_valid_parent = None
    
    for item in toc_items:
        # å¦‚æœå½“å‰æ˜¯ Level 1 ä½†ä¸æ˜¯ç« èŠ‚æ ‡é¢˜ï¼Œå¯èƒ½åº”è¯¥æ˜¯ Level 2 æˆ– 3
        if item['level'] == 1 and not is_chapter_title(item['title']):
            # æ ¹æ®ä¸Šä¸‹æ–‡åˆ¤æ–­åº”è¯¥æ˜¯ä»€ä¹ˆçº§åˆ«
            if last_valid_parent:
                # ä½œä¸ºä¸Šä¸€ä¸ªæœ‰æ•ˆçˆ¶èŠ‚ç‚¹çš„å­èŠ‚ç‚¹
                item['level'] = last_valid_parent['level'] + 1
            else:
                # è·³è¿‡
                continue
        
        if item['level'] == 1:
            last_valid_parent = item
        
        fixed.append(item)
    
    return fixed
```

### æ–¹æ¡ˆ2: å›é€€åˆ°æ–‡æœ¬è¯†åˆ«TOC

å¦‚æœåµŒå…¥å¼TOCè´¨é‡å¤ªå·®ï¼Œå¯ä»¥å®Œå…¨æ”¾å¼ƒå®ƒï¼Œæ”¹ç”¨æ–‡æœ¬åˆ†æï¼š

```python
def detect_toc_quality(toc_items):
    """è¯„ä¼°åµŒå…¥å¼TOCçš„è´¨é‡"""
    issues = 0
    
    for item in toc_items:
        title = item['title']
        
        # æ£€æµ‹å„ç§é—®é¢˜
        if len(title) > 50:  # è¿‡é•¿
            issues += 1
        if len(title) <= 1:  # å•å­—ç¬¦
            issues += 1
        if 'ã€‚' in title or 'ï¼Œ' in title:  # åŒ…å«å¥å­ç»“æŸç¬¦
            issues += 1
    
    quality_score = 1 - (issues / len(toc_items))
    return quality_score

# åœ¨ TOC æ£€æµ‹é˜¶æ®µï¼š
toc_quality = detect_toc_quality(embedded_toc)

if toc_quality < 0.7:  # è´¨é‡å¤ªå·®
    logger.warning(f"åµŒå…¥å¼TOCè´¨é‡è¾ƒå·® (è´¨é‡åˆ†: {toc_quality:.2f})ï¼Œå›é€€åˆ°æ–‡æœ¬åˆ†æ")
    # ä½¿ç”¨æ–‡æœ¬åˆ†ææå–TOC
    toc_items = extract_toc_from_text(pdf)
else:
    logger.info(f"ä½¿ç”¨åµŒå…¥å¼TOC (è´¨é‡åˆ†: {toc_quality:.2f})")
    # æ¸…ç†å’Œä¿®å¤
    toc_items = clean_toc(embedded_toc)
    toc_items = fix_toc_hierarchy(toc_items)
```

### æ–¹æ¡ˆ3: ä¸¤ç§æ–¹æ³•æ··åˆ

1. ä»åµŒå…¥å¼TOCæå–ç« èŠ‚ç»“æ„ï¼ˆLevel 1ï¼‰
2. ä»æ–‡æœ¬åˆ†æä¸­æå–è¯¦ç»†å­èŠ‚ï¼ˆLevel 2+ï¼‰
3. åˆå¹¶ä¸¤è€…ç»“æœ

## å®æ–½å»ºè®®

### çŸ­æœŸæ–¹æ¡ˆï¼ˆç«‹å³å¯å®æ–½ï¼‰
åœ¨ `pageindex_v2/phases/toc_detector.py` ä¸­æ·»åŠ  TOC æ¸…ç†é€»è¾‘ï¼š

```python
# åœ¨æå–åµŒå…¥å¼TOCåï¼š
if embedded_toc:
    # æ¸…ç†æ— æ•ˆé¡¹
    embedded_toc = clean_toc(embedded_toc)
    
    # ä¿®å¤å±‚çº§å…³ç³»
    embedded_toc = fix_toc_hierarchy(embedded_toc)
    
    # è¯„ä¼°è´¨é‡
    quality = detect_toc_quality(embedded_toc)
    
    if quality < 0.7:
        logger.warning("åµŒå…¥å¼TOCè´¨é‡ä¸ä½³ï¼Œè€ƒè™‘å¯ç”¨æ–‡æœ¬åˆ†æ")
```

### é•¿æœŸæ–¹æ¡ˆ
1. å®ç°æ™ºèƒ½TOCè´¨é‡è¯„ä¼°
2. å®ç°è‡ªåŠ¨å›é€€æœºåˆ¶
3. æä¾›æ‰‹åŠ¨TOCç¼–è¾‘ç•Œé¢
4. æ·»åŠ  TOC ä¿®å¤å»ºè®®åŠŸèƒ½

## ç›¸å…³æ–‡ä»¶

éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶ï¼š
- `pageindex_v2/phases/toc_detector.py` - æ·»åŠ TOCæ¸…ç†é€»è¾‘
- `pageindex_v2/phases/toc_extractor.py` - æ·»åŠ è¿‡æ»¤å™¨
- `pageindex_v2/phases/tree_builder.py` - æ”¹è¿›æ ‡é¢˜éªŒè¯

## æµ‹è¯•ç”¨ä¾‹

è¿™ä¸ªæ–‡æ¡£ï¼ˆ53b33b4fï¼‰æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æµ‹è¯•ç”¨ä¾‹ï¼Œå¯ä»¥ç”¨æ¥éªŒè¯ï¼š
1. è¿‡æ»¤æ— æ•ˆæ ‡é¢˜
2. è¯†åˆ«ç« èŠ‚æ¨¡å¼
3. ä¿®å¤å±‚çº§å…³ç³»
4. è´¨é‡è¯„ä¼°

## é¢„æœŸæ•ˆæœ

ä¿®å¤åï¼Œç›®å½•ç»“æ„åº”è¯¥æ˜¯ï¼š

```
ç¬¬ä¸€ç«  æ‹›æ ‡å…¬å‘Š
ç¬¬äºŒç«  æŠ•æ ‡äººé¡»çŸ¥
  ï¼ˆä¸€ï¼‰é€‚ç”¨èŒƒå›´
  ï¼ˆäºŒï¼‰å®šä¹‰
  ï¼ˆä¸‰ï¼‰æŠ•æ ‡è´¹ç”¨
  äº”ã€è¯„æ ‡
    ï¼ˆä¸€ï¼‰è¯„å®¡å·¥ä½œçš„ç»„ç»‡
    ï¼ˆäºŒï¼‰è¯„æ ‡å§”å‘˜ä¼šçš„ç»„å»º
    ï¼ˆä¸‰ï¼‰è¯„æ ‡å§”å‘˜ä¼šçš„èŒè´£
    ï¼ˆäº”ï¼‰è¯„å®¡æ„è§çš„äº‰è®®å¤„ç†
    ï¼ˆå…­ï¼‰è¯„å§”çºªå¾‹
    ï¼ˆä¸ƒï¼‰è¯„å®¡æµç¨‹åŠå†…å®¹
ç¬¬ä¸‰ç«  è¯„æ ‡åŠæ³•åŠè¯„åˆ†æ ‡å‡†
ç¬¬å››ç«  é‡‡è´­éœ€æ±‚
ç¬¬äº”ç«  åˆåŒæ–‡æœ¬  # å¯èƒ½è¢«è¿‡æ»¤äº†ï¼Œéœ€è¦ä»æ–‡æœ¬ä¸­æ¢å¤
ç¬¬å…­ç«  æŠ•æ ‡æ–‡ä»¶æ ¼å¼é™„ä»¶
  é™„ä»¶1: æŠ•æ ‡å‡½
  é™„ä»¶2: å¼€æ ‡ä¸€è§ˆè¡¨
  é™„ä»¶3: æŠ•æ ‡æŠ¥ä»·æ˜ç»†è¡¨
  é™„ä»¶: æ”¿åºœé‡‡è´­æ´»åŠ¨ç°åœºç¡®è®¤å£°æ˜ä¹¦
```

## ä¼˜å…ˆçº§

ğŸ”´ **é«˜ä¼˜å…ˆçº§**
- å®ç°æ ‡é¢˜é•¿åº¦è¿‡æ»¤
- å®ç°å•å­—ç¬¦è¿‡æ»¤
- å®ç°å¥å­ç»“æŸç¬¦æ£€æµ‹

ğŸŸ¡ **ä¸­ä¼˜å…ˆçº§**
- å®ç°ç« èŠ‚æ¨¡å¼è¯†åˆ«
- å®ç°å±‚çº§ä¿®å¤
- å®ç°è´¨é‡è¯„ä¼°

ğŸŸ¢ **ä½ä¼˜å…ˆçº§**
- å®ç°æ™ºèƒ½å›é€€
- å®ç°æ··åˆæ¨¡å¼
- æä¾›æ‰‹åŠ¨ç¼–è¾‘ç•Œé¢
